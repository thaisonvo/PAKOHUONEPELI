<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotisivu - Pakohuonepelit</title>
    <style>
        body {
            background-color: black;
            color: white;
        }
        .centered-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #leaderboardTable td {
            width: 33%;
            text-align: center;
        }
        </style>
</head>

<body>
    <div class="container">
        <div class="text-content" style="text-align: center;">
            <h1>Tervetuloa Pakohuonepelit-sivustolle!</h1>
            <p>Valitse alla olevasta valikosta haluamasi pakohuone ja aloita peli painamalla "Aloita peli" -nappia.</p>
            <select id="allEscapeRooms" required>
                <option value="" disabled selected>Valitse pakohuone</option>
            </select>
            <input type="text" id="playerName" placeholder="Syötä nimesi tähän..." required></input>
            <button id="startGameButton">Aloita peli</button>
        </div>

        <div class="centered-container">
            <h2 id=leaderboardTitle></h2>
            <table id="leaderboardTable">
                <!-- Scores -->
            </table>
    </div>

    <script>
        async function fetchEscapeRooms() {
            try {
                const response = await fetch("/allEscapeRooms");
                if (!response.ok) {
                    throw new Error(`Failed to retrieve escape rooms.)`);
                }
                const escapeRooms = await response.json();
                return escapeRooms;
            } catch (error) {
                console.error(error);
            }
        }

        async function initializePlayerAndStartGame(escapeRoom, playerName) {
            try {
                const response = await fetch('/api/initializePlayer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ escapeRoom, playerName })
                });
                if (!response.ok) {
                    throw new Error('Failed to initialize player data and start a game.');
                }

                window.location.href = "/maingamepage";
            } catch (error) {
                console.error(error);
            }
        }

        async function renderLeaderBoard(escapeRoom) {
            const res = await fetch(`/getLeaderboardData/${escapeRoom}`);
            const data = await res.json();
            const leaderboardTable = document.getElementById("leaderboardTable");
            const leaderboardTitle = document.getElementById("leaderboardTitle").innerText = `Pakohuoneen '${escapeRoom}' Top 10 nopeimmat:`;

            data.forEach((player, index) => {
                const row = document.createElement('tr');
                const rank = document.createElement('td');
                const name = document.createElement('td');
                const time = document.createElement('td');
                rank.innerText = `${index + 1}.`;
                name.innerText = player.playerName;
                time.innerText = `${player.time} s`;
                row.appendChild(rank);
                row.appendChild(name);
                row.appendChild(time);
                leaderboardTable.appendChild(row);
            });
        }

        function renderDropdownMenu(data, id) {
            const dropdownMenu = document.getElementById(id);
            
            data.forEach(room => {
                const option = document.createElement("option");
                option.value = room;
                option.innerText = room;
                dropdownMenu.appendChild(option);
            });
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const allEscapeRooms = await fetchEscapeRooms();

            if (!allEscapeRooms) {
                return;
            }

            renderDropdownMenu(allEscapeRooms, "allEscapeRooms");

            const dropdownMenu = document.getElementById("allEscapeRooms");
            let selectedEscapeRoom;
            dropdownMenu.addEventListener("change", () => {
                document.getElementById("leaderboardTable").innerHTML = "";
                selectedEscapeRoom = dropdownMenu.value;
                renderLeaderBoard(selectedEscapeRoom);
            });

            const startGameButton = document.getElementById("startGameButton");
            startGameButton.addEventListener("click", () => {
                const selectedEscapeRoom = document.getElementById("allEscapeRooms").value;
                const playerName = document.getElementById("playerName").value;
                initializePlayerAndStartGame(selectedEscapeRoom, playerName);
            });
        });
    </script>
</body>
</html>