<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotisivu - Pakohuonepelit</title>
    <link rel="stylesheet" href="stylegameIndex.css">
</head>
<body>
    <div class="hero-section">
        <h1 class="title">Tervetuloa Pakohuonepeliin!</h1>
        <div class="box-container">
            <div class="game-selection">
                <select id="allEscapeRooms" required>
                    <option value="" disabled selected>Valitse pakohuone</option>
                    <!-- Other options here -->
                </select>
                <input type="text" id="playerName" placeholder="Syötä nimesi tähän..." required>
                <button id="startGameButton">Aloita peli</button>
            </div>
            <div class="leaderboard">
                <h2 id="leaderboardTitle"></h2>
                <table id="leaderboardTable">
                    <!-- Scores will be populated here -->
                </table>
            </div>
        </div>
    </div>

    <script>
        async function fetchEscapeRooms() {
            try {
                const response = await fetch("/allEscapeRooms");
                if (!response.ok) {
                    throw new Error(`Failed to retrieve escape rooms.)`);
                }
                const escapeRooms = await response.json();
                return escapeRooms;
            } catch (error) {
                console.error(error);
            }
        }

        async function initializePlayerAndStartGame(escapeRoom, playerName) {
            try {
                const response = await fetch('/api/initializePlayer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ escapeRoom, playerName })
                });
                if (!response.ok) {
                    throw new Error('Failed to initialize player data and start a game.');
                }

                window.location.href = "/maingamepage";
            } catch (error) {
                console.error(error);
            }
        }

        async function renderLeaderBoard(escapeRoom) {
            const res = await fetch(`/getLeaderboardData/${escapeRoom}`);
            const data = await res.json();
            const leaderboardTable = document.getElementById("leaderboardTable");
            const leaderboardTitle = document.getElementById("leaderboardTitle").innerText = `Pakohuoneen '${escapeRoom}' Top 10 nopeimmat:`;

            data.forEach((player, index) => {
                const row = document.createElement('tr');
                const rank = document.createElement('td');
                const name = document.createElement('td');
                const time = document.createElement('td');
                rank.innerText = `${index + 1}.`;
                name.innerText = player.playerName;
                time.innerText = `${player.time} s`;
                row.appendChild(rank);
                row.appendChild(name);
                row.appendChild(time);
                leaderboardTable.appendChild(row);
            });
        }

        function renderDropdownMenu(data, id) {
            const dropdownMenu = document.getElementById(id);
            
            data.forEach(room => {
                const option = document.createElement("option");
                option.value = room;
                option.innerText = room;
                dropdownMenu.appendChild(option);
            });
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const allEscapeRooms = await fetchEscapeRooms();

            if (!allEscapeRooms) {
                return;
            }

            renderDropdownMenu(allEscapeRooms, "allEscapeRooms");

            const dropdownMenu = document.getElementById("allEscapeRooms");
            let selectedEscapeRoom;
            dropdownMenu.addEventListener("change", () => {
                document.getElementById("leaderboardTable").innerHTML = "";
                selectedEscapeRoom = dropdownMenu.value;
                renderLeaderBoard(selectedEscapeRoom);
            });

            const startGameButton = document.getElementById("startGameButton");
            startGameButton.addEventListener("click", () => {
                const selectedEscapeRoom = document.getElementById("allEscapeRooms").value;
                const playerName = document.getElementById("playerName").value;
                initializePlayerAndStartGame(selectedEscapeRoom, playerName);
            });
        });
    </script>
</body>
</html>