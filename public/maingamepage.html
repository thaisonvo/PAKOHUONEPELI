<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pakohuonepeli</title>
    <link rel="stylesheet" href="stylesheet_main.css">
</head>
<body>
    <div class="wrapper">
        <header class="header">
            <div class="timerContainer">
                <div id="timerDisplay">01:30:00</div>
            </div>
            <h1 id="gameTitle">Tervetuloa Pakohuonepeliin!</h1>
            <div class="spacer"></div>
        </header>
        <div class="instructions">
            <h2>Ohjeet pelaajalle:</h2>
            <div id="instructionsContent"></div>
        </div>
        <div class="video-container">
            <iframe class="video" id="escapeRoomVideo" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <footer class="footer">
            <div class="contentContainer">
                <button id="startGameButton">Aloita peli</button>
                <div class="buttons" style="display: none;">
                    <input id="codeInput" type="text" placeholder="Syötä koodi tähän">
                    <button id="checkTheCode">Tarkista koodi</button>
                    <button id="vihje">Näytä vihje</button>
                </div>
                <button id="continueButton" style="display: none;">Jatka seuraavaan huoneeseen</button>
                <div class="hintIndicatorsContainer" id="hintIndicators"></div>
            </div>
        </footer>
        <div id="hintModal" class="modal">
            <div class="modal-content">
                <span class="close" title="Sulje">&times;</span>
                <span class="minimize" title="Pienennä">&#8211;</span>
                <p id="modalHintText">Tässä vinkki:</p>
            </div>
        </div>
    </div>

    <script>
        // Fetch information about the selected escape room.
        fetch(`/api/game/getIntroduction`)
            .then(response => response.json())
            .then(data => updateContent(data))
            .catch(error => {
                console.error(error);
                window.location.href = '/';
            });

        // Event listener for the 'start game' button.
        const startButton = document.getElementById("startGameButton");
        startButton.addEventListener("click", async () => {
            try {
                await fetch("/api/game/startGame", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // Fetch the first question of the escape room.
                const response = await fetch("/api/game/getQuestion");
                const data = await response.json();

                // Update the content of the page.
                updateContent(data);
                document.querySelector(".buttons").style.display = "block";
                startButton.style.display = "none";

                //Starts the timer check
                checkTime();

                if (!timerInterval) {
                    setInterval(checkTime, 60000);
                }
            } catch (error) {
                console.error(error);
            }
        });

        // Event listener for handling answer submissions.
        const submitAnswer = document.getElementById("checkTheCode");
        submitAnswer.addEventListener("click", async () => {
            try {
                // Extract the inputted answer.
                const answer = document.getElementById("codeInput").value;
                // Send a request to the server with the inputted answer for validation.
                const response = await fetch("/api/game/checkAnswer", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answer })
                })
                const data = await response.json();

                if (data.finished) {
                    window.location.href = `/congratulations/?escapeRoom=${data.escapeRoom}`;
                    return;
                }

                if (!data.correct) {
                    alert("Väärä vastaus! Yritä uudelleen.");
                    document.getElementById("codeInput").value = '';
                } else {
                    //If answer is right and there's problems left, hide codeInput and check+hint buttons -> Show continue -button
                    document.getElementById("continueButton").style.display = 'block';
                    document.getElementById("codeInput").style.display = 'none';
                    document.getElementById("checkTheCode").style.display = 'none';
                    document.getElementById("vihje").style.display = 'none';
                }
            } catch (error) {
                console.error(error);
            }
    
            //The eventlistener for the continue-button
            const continueButton = document.getElementById("continueButton");
            continueButton.addEventListener("click", async () => {
                const nextQuestion = await fetch('/api/game/getQuestion');
                const nextData = await nextQuestion.json();
                updateContent(nextData);

                document.getElementById("codeInput").style.display = 'block';
                document.getElementById("checkTheCode").style.display = 'inline-block';
                document.getElementById("vihje").style.display = 'inline-block';
                document.getElementById("continueButton").style.display = 'none';
                document.getElementById("codeInput").value = '';
            });
        });


        // Is hint-modal open
        let isHintModalOpen = false;
        // Event listener for showing a hint.
        const showHint = document.getElementById("vihje");
        showHint.addEventListener("click", async () => {
            if (!isHintModalOpen) {
                try {
                    // Fetch a hint from the server.
                    const response = await fetch("/api/game/getHint");
                    const data = await response.json();

                    // Update hint indicators only if modal is not open.
                    updateHintIndicators();
                    isHintModalOpen = true;

                    // Display the hint in the hint window.
                    document.getElementById("modalHintText").innerText = data.hint;
                    document.getElementById("hintModal").style.display = 'block';

                } catch (error) {
                    console.error(error);
                }
            } else {
                // Only opens the last hint again, not updating hintcount or indicators
                document.getElementById("hintModal").style.display = 'block';
            }
        });

        // Event listener for minimizing the hint window.
        const minimizeHint = document.querySelector(".minimize");
        minimizeHint.addEventListener("click", () => {
            document.getElementById("hintModal").style.display = 'none';
        });

        // Event listener for closing the hint window with the close button.
        const closeHint = document.querySelector(".close");
        closeHint.addEventListener("click", () => {
            const ConfirmClose = confirm('Haluatko varmasti sulkea vinkin? Et voi enää palata tähän vinkkiin tämän jälkeen.');
            if (ConfirmClose) {
                document.getElementById("hintModal").style.display = 'none';
                isHintModalOpen = false; // Resets the hintmodal status, when hint-modal is closed
            }   
        });

        async function updateHintIndicators() {
            // Optionally, fetch the latest hint count from the server, or maintain it in client state.
            const response = await fetch("/api/game/hintCount");
            const data = await response.json();
            const hintCount = data.hintsLeft;

            const hintIndicators = document.getElementById("hintIndicators");
            hintIndicators.innerHTML = ''; // Clear current indicators

            // Generate and display new indicators
            for (let i = 0; i < hintCount; i++) {
                let indicator = document.createElement("span");
                indicator.className = "hintIndicator";
                indicator.textContent = "★";
                hintIndicators.appendChild(indicator);
            }
        }

        // Updates the title, description and video of the page.
        function updateContent(data) {
            console.log('updating content')
            document.getElementById("gameTitle").innerText = data.title;
            document.getElementById("instructionsContent").innerHTML = data.description;
            const video = data.video.split('v=')[1];
            document.getElementById("escapeRoomVideo").src = `https://www.youtube.com/embed/${video}`;
        }


        let timerInterval;

        //Function to check the remaining game time
        function checkTime() {
            //Sends a GET request to the endpoint on the server
            fetch('/api/game/checkTime')
                .then(response => response.json())
                .then(data => {
                    //Checks is the timeIsUp -in the response true
                    if (data.timeIsUp) {
                        alert("Aikasi on päättynyt!");
                        clearInterval(timerInterval);
                    } else {
                        startLocalCountdown(data.timeLeft);
                    }
                })
                .catch(error => console.error('Error checking time:', error));
            }

        //Calls the checkTime -function periodically in every minute
        setInterval(checkTime, 60000); // 60 000 ms = 1min

        function startLocalCountdown(timeLeftInSeconds) {
            clearInterval(timerInterval);
            const endTimestamp = Date.now() + timeLeftInSeconds * 1000;

            timerInterval = setInterval(() => {
                const secondsLeft = Math.round((endTimestamp - Date.now()) / 1000);
                if (secondsLeft <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timerDisplay').textContent = "00:00:00";
                } else {
                    const hours = Math.floor(secondsLeft / 3600);
                    const minutes = Math.floor((secondsLeft % 3600) / 60);
                    const seconds = secondsLeft % 60;
                    document.getElementById('timerDisplay').textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

    </script>
</body>
</html>