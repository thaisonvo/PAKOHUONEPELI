<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pakohuonepeli</title>
    <link rel="stylesheet" href="stylesheet_main.css">
</head>
<body>
    <div class="wrapper">
        <header class="header">
            <div class="timerContainer">
                <div id="timerDisplay" >01:30:00</div>
            </div>
            <h1 id="gameTitle">Tervetuloa Pakohuonepeliin!</h1>
            <div class="spacer"></div>
        </header>
        <div class="instructions">
            <h2>Ohjeet pelaajalle:</h2>
            <div id="instructionsContent"></div>
        </div>
        <div class="video-container">
            <iframe class="video" id="escapeRoomVideo" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <footer class="footer">
            <button id="startGameButton">Aloita peli</button>
            <div class="buttons" style="display: none;">
                <input id="codeInput" type="text" placeholder="Syötä koodi tähän">
                <button id="checkTheCode">Tarkista koodi</button>
                <button id="vihje">Näytä vihje</button>
                <div id="hintsVisualContainer"></div>
            </div>
            <button id="continueButton" style="display: none;">Jatka seuraavaan huoneeseen</button>
        </footer>
        <div id="hintModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <span class="minimize">&#8211;</span>
                <p id="modalHintText">Tässä vinkki:</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Alustetaan muuttujat pelin datalle, nykyisen huoneen indeksille ja vihjeiden määrälle
            let escapeRoomData = [];
            let currentRoomIndex = 0;
            let vihjeCount = 0;
    
            // Haetaan viittaukset DOM-elementteihin
            const startGameButton = document.getElementById("startGameButton");
            const buttonsDiv = document.querySelector(".buttons");
            const continueButton = document.getElementById("continueButton");
            const instructionsContent = document.getElementById("instructionsContent");
            const escapeRoomVideo = document.getElementById("escapeRoomVideo");
            const codeInput = document.getElementById("codeInput");
            const hintModal = document.getElementById("hintModal");
            const modalHintText = document.getElementById("modalHintText");
            const closeModal = document.querySelector(".close");
            const minimizeButton = document.querySelector(".minimize");
            const hintButton = document.getElementById("vihje");
            const hintsVisualContainer = document.getElementById("hintsVisualContainer");
    
            // Määritellään tapahtumankäsittelijät
    
            // Sulkee vihjeikkunan ja päivittää vihjeiden määrän
            closeModal.addEventListener("click", function() {
                hintModal.style.display = "none";
                // Vähennetään vihjeiden määrää, jos vihjeitä on jäljellä
                if (vihjeCount < escapeRoomData[currentRoomIndex].problems[0].hints.length) {
                    vihjeCount++;
                }
                updateHintVisuals(); // Päivittää vihjeiden visuaaliset merkit
            });
    
            // Piilottaa vihjeikkunan
            minimizeButton.addEventListener("click", function() {
                hintModal.style.display = "none";
            });
    
            // Aloittaa pelin ja hakee pelin datan
            startGameButton.addEventListener("click", function() {
                startGameButton.style.display = "none";
                buttonsDiv.style.display = "flex";
                fetchEscapeRoomData();
                //Ajastimen asetukset ja käynnistys, kun peli aloitetaan
                var timerDuration = 60 * 90; //1h 30min
                var display = document.getElementById('timerDisplay');
                startTimer(timerDuration, display);
            });
    
            // Näyttää vihjeen
            hintButton.addEventListener("click", showHint);
    
            // Tarkistaa syötetyn koodin
            document.getElementById("checkTheCode").addEventListener("click", function () {
                checkTheCode();
            });
    
            // Hakee pakohuoneiden datan palvelimelta
            function fetchEscapeRoomData() {
                fetch('/allEscapeRooms')
                    .then(response => response.json())
                    .then(data => {
                        escapeRoomData = data;
                        loadRoomData(currentRoomIndex); // Lataa nykyisen huoneen datan
                    })
                    .catch(error => {
                        console.error('Virhe ladattaessa pakohuoneiden dataa:', error);
                        alert('Pelin tietojen lataaminen epäonnistui.');
                    });
            }
    
            // Lataa nykyisen huoneen tiedot ja asettaa näkymän
            function loadRoomData(index) {
                if (index < escapeRoomData.length) {
                    const room = escapeRoomData[index];
                    document.getElementById("gameTitle").textContent = room.title; // Päivittää pelin otsikon
                    instructionsContent.innerHTML = `<p>${room.description}</p>`; // Päivittää ohjeet/kuvaus
                    escapeRoomVideo.src = room.videoLink.replace("watch?v=", "embed/"); // Päivittää videon
                    updateHintVisuals(); // Päivittää vihjeiden visuaaliset merkit
                    continueButton.style.display = "none"; // Piilottaa "Jatka seuraavaan huoneeseen" -napin
                    buttonsDiv.style.display = "flex"; // Näyttää ohjausnapit
    
                } else {
                    alert("Olet suorittanut kaikki huoneet!");
                    // Voitaisiin piilottaa kaikki ohjausnapit tai näyttää "Aloita alusta" -nappi
                }
            }
    
            // Näyttää vihjeen, jos vihjeitä on jäljellä
            function showHint() {
                if (vihjeCount < escapeRoomData[currentRoomIndex].problems[0].hints.length) {
                    modalHintText.textContent = "Vinkki: " + escapeRoomData[currentRoomIndex].problems[0].hints[vihjeCount];
                    hintModal.style.display = "block";
                } else {
                    alert("Ei enää vihjeitä jäljellä!");
                }
            }
    
            // Tarkistaa, onko syötetty koodi oikein, ja käsittelee tuloksen
            document.getElementById("checkTheCode").addEventListener("click", function () {
                const room = escapeRoomData[currentRoomIndex];
                    if (codeInput.value === room.problems[0].correctAnswer) {
                        alert("Koodi on oikein!");
                        if (currentRoomIndex < escapeRoomData.length - 1) {
                        currentRoomIndex++; // Siirrytään seuraavaan huoneeseen
                        continueButton.style.display = "block"; // Näytetään "Jatka seuraavaan huoneeseen" -nappi
                        buttonsDiv.style.display = "none"; // Piilotetaan muut ohjausnapit
                        } else {
                            alert("Olet suorittanut kaikki huoneet!");
                            // Määritellään tähän tulevaisuudessa esim. tulos sivulle siirtyminen
                        }
                    } else {
                        alert("Koodi on väärin. Yritä uudelleen!");
                    }
                    codeInput.value = ""; // Tyhjennetään syötekenttä
            });
    
            // Siirtyy seuraavaan huoneeseen
            continueButton.addEventListener("click", function() {
                if (currentRoomIndex < escapeRoomData.length) {
                    buttonsDiv.style.display = "flex"; // Näyttää ohjausnapit
                    continueButton.style.display = "none"; // Piilottaa "Jatka seuraavaan huoneeseen" -napin
                    
                    loadRoomData(currentRoomIndex); // Lataa seuraavan huoneen tiedot
                    
                }
            });
    
            // Päivittää vihjeiden visuaaliset merkit
            function updateHintVisuals() {
                hintsVisualContainer.innerHTML = "";
                const room = escapeRoomData[currentRoomIndex];
                let hintsLeft = room.problems[0].hints.length - vihjeCount;
                for (let i = 0; i < hintsLeft; i++) {
                    let hintVisual = document.createElement("span");
                    hintVisual.classList.add("hintVisual");
                    hintsVisualContainer.appendChild(hintVisual);
                }
            }

            //Ajastimen logiikka tässä
            function startTimer(duration, display) {
                var start = Date.now(),
                    diff,
                    hours,
                    minutes,
                    seconds;
                function timer() {
                    //Lasketaan jäljellä oleva aika
                    diff = duration - (((Date.now() - start) / 1000) | 0);

                    hours = ((diff / 3600) | 0);
                    minutes = ((diff % 3600) / 60) | 0;
                    seconds = (diff % 60) | 0;

                    hours = hours < 10 ? "0" + hours : hours;
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;

                    display.textContent = hours + ":" + minutes + ":" + seconds;

                    if (diff <=0) {
                        //Kun aika loppuu...
                        clearInterval(timerInterval);
                        display.textContent = "Aika on nyt päättynyt!";
                        //Määritetään tähän mitä tapahtuu pelissä, kun aika on loppunut
                    }

                };

                //Päivitetään ajastinta joka sekunnilla
                timer();
                var timerInterval = setInterval(timer, 1000);
            }
        });
    </script>
    
</body>
</html>